<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Optimized C++ 책을 읽고나서 | JooHyoung Cha </title> <meta name="author" content="JooHyoung Cha"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://blog.udon.party/blog/2024/my-comment-of-reading-optimized-cpp/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">JooHyoung</span> Cha </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Optimized C++ 책을 읽고나서</h1> <p class="post-meta"> Created in June 22, 2024 by piorosen </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/read"> <i class="fa-solid fa-hashtag fa-sm"></i> read</a>   ·   <a href="/blog/category/blogging"> <i class="fa-solid fa-tag fa-sm"></i> Blogging</a>   <a href="/blog/category/review"> <i class="fa-solid fa-tag fa-sm"></i> Review</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="개요">개요</h1> <p>1줄 요약: 초보자를 위한 책도 아닌, 중급자 그 이상이 읽어야 정말 재밌습니다.</p> <p>C++ 언어를 공부하면서 조금 더 많은 언어적인 테크닉에 대해서 공부하고 싶었었다. 그래서 컴파일러를 통해 배우는 C++ 언어라던지, Effective C++ 등 다양한 책을 읽어보았었다. 특히, 필자는 언어적인 테크닉 외에 조금 무언가 로우 레벨적으로 최적화를 이뤄보고 싶었기 떄문에 <code class="language-plaintext highlighter-rouge">Optimized C++</code> 책을 읽어보고 싶다! 란 생각을 하게 된 것 같다. 결론적으로 이야기를 하자면 나름 재미있었고, C++의 STL 라이브러리는 상당히 빠르면서 동시에 범용성을 지녔기 때문에 느리다는것을 알게 되었다. 그래서 STL 라이브러리를 사용하는것 보다 직접 구현한다면 (C언어 형태로 구현한) 성능 개선이 상당히 이뤄질수 있다는 것이 인상적이였다.</p> <p><code class="language-plaintext highlighter-rouge">Optmized C++</code>의 책에서 이야기 하는 내용은 하드웨어적인 최적화 관련된것이 아닌, 범용적으로 언어적인 레벨, 이동식 시멘트나 생성자, 메모리 매니저와 같은 내용이였다. 그래서 이 책을 읽고자하는 독자가 있다면, 어떻게 코드를 이쁘고 효율적으로 최적화할것인지 한다면 최고인 책인것 같다. 즉, 하드웨어적인 (캐시 메모리, 하드웨어의 Instruction Set Architecture에 종속적이지 않은) 내용은 없다.</p> <h1 id="핵심-내용">핵심 내용</h1> <p>필자가 재밌게 읽었던 부분을 요약하자면 아래와 같고, 이름은 필자가 조금 변형하였다.</p> <ol> <li>메모리를 읽는건 1바이트가 아닌 동시에 많은 데이터를 읽습니다. (45p)</li> <li>문자열은 잦은 메모리 재할당과 복사가 자주 발생합니다. (110p)</li> <li>기초적인 알고리즘 최적화 기법 (chapter 5) (너무 당연한 이야기들)</li> <li>스마트 포인터는 성능과 거리가 멉니다. (162p)</li> <li>비 캡처 람다는 일반 정적 함수에서 이름이 없는 것과 같다. (위치 까먹었습니다..)</li> <li>클래스 상속과 가상 함수는 매우 매우 매우 느리다. (위치 까먹었습니다..)</li> <li> <code class="language-plaintext highlighter-rouge">do-while</code>은 어셈블리 입장에서 효율적 입니다. (위치 까먹었습니다..)</li> <li>라이브러리 바깥에서 메모리 할당하도록 결정하세요. (264p) RVO 기법(187p)</li> <li>검색 및 정렬 최적화 챕터(최고!) <a href="http://ascode.org/problem.php?id=1457" rel="external nofollow noopener" target="_blank">[너무 재밌어서 문제로 만들어보았습니다.]</a> </li> <li>메모리 관리 최적화 (너무 어렵습니다..)</li> </ol> <h1 id="요약">요약</h1> <p>필자가 열심히 공부하면서 얻었던 지식을 한번 더, 책으로 읽을수 있어서 정말로 좋았습니다. 하지만, 책의 두께라던지, 각 문단 문단 하나가 너무 크게 <code class="language-plaintext highlighter-rouge">퉁</code> 쳐져 있는 듯하고, 너무 광대한 범위를 적은 페이지수로 설명하다 보니 아쉬웠던 점이 넘 많았습니다. 예시로는 필자가 작성한 핵심 내용 (1) 으로, CPU 는 메모리로 부터 데이터를 읽을 때 1 바이트씩 읽는것이 아닌 64 바이트씩 데이터를 읽는다. 라는 내용이다. 여기서, <code class="language-plaintext highlighter-rouge">Optmized C++</code>은 단순하게 메모리는 랜덤 엑세스가 가능하지만, 캐시 메모리로 인해, 순차 접근하는것이 더 효율적이다 라는 내용으로 끝나게 된다.</p> <p>하지만, 실상은 여기서 끝나는것이 아니라, 멀티 쓰레드 환경에서 <code class="language-plaintext highlighter-rouge">False Sharing</code>이라는 문제도 발생한다. 이 처럼 뭔가… 책의 페이지수를 2000 페이지이나 3000 페이지로 늘려도 괜찮으니, 더 자세하고 많은 내용으로 적어줬으면 좋았을것 같았다. (약간 욕심이다.)</p> <p>각각 요소를 필자가 기억하기 정리하는 목적으로 작성할 계획이다.</p> <h2 id="요약-2">요약 2</h2> <ol> <li>메모리를 읽는건 1바이트가 아닌 동시에 많은 데이터를 읽습니다. (45p)</li> </ol> <p>엄청 옛날의 시스템이나, 아두이노 같은 마이크로 프로세서의 경우에는 CPU에 집적가능한 회로의 수가 적으므로 프로그램 코드를 메모리로 부터 읽는것에 많은 회로를 작성하는 것이 어렵다. 또한, 캐시 메모리 없이 DRAM에서 바로 Register로 적재하는 경우도 있다. 그렇지만 이는 엄청 적은 임베디드 시스템이지, 일반적인 대형 컴퓨터 또는 일반 컴퓨터에 들어가는 CPU (x86 계열)의 경우에는 캐시메모리와 더 많은 레지스터, 한 번에 많은 데이터를 DRAM으로 부터 읽어온다. 따라서 일반적인 컴퓨팅 환경에서는 1바이트씩 메모리로부터 읽는것이 아닌 64 바이트나 특정 바이트의 수 만큼 데이터를 읽어서 캐시 메모리로 데이터를 적재한다.</p> <p>그렇기 때문에, DRAM은 랜덤 엑세스가 가능하지만, 캐시 메모리로 데이터를 읽어서 적재하는 과정에서 순차적으로 데이터가 정렬되어 있어야 효율적이므로, 최대한 메모리를 순차적으로 정렬해 두는것이 좋다.</p> <p>그렇다면 여기서 의문이 들 수 있다. 캐시 메모리의 크기에 맞춰서 데이터를 읽고, 재정렬하고 랜덤 액세스 하도록 만든다면 성능 개선이 이뤄질까? 라는 내용이다. 정답이다. 놀랍게도 이쪽으로 연구 분야로 <code class="language-plaintext highlighter-rouge">Cache Aware for Computation</code> 이라는 주제로 존재한다.</p> <p>두 번째로 의문은 하나가 더 있다. 해당 책의 경우에서는 딱 하나의 경우, 싱글 쓰레드의 경우에서 문제점을 제기하였다. 그래서 더 많이 다뤄야하는 주제임에도 불구하고, 책의 두께나 내용상으로 생략한 내용이 있다. 필자가 생각하는 추가적인 문제는, 싱글 쓰레드가 아닌 멀티 쓰레드 환경에서 <code class="language-plaintext highlighter-rouge">Cache Memory</code>로 인한 데이터 정합성 쉽게 발생하는 문제가 있다.</p> <p>주제로는 <code class="language-plaintext highlighter-rouge">False Sharing</code> 이라는 주제인데, 코드에서 변수 선언은 <code class="language-plaintext highlighter-rouge">Stack Memory</code>나 <code class="language-plaintext highlighter-rouge">Data Section</code> 에서 생성 되었고, 순차적으로 데이터를 선언했을 때 발생하는 문제이다. 여기서 다룰 주제는 아니므로, 간단하게 설명하자면, 아래의 코드를 생성하고, <code class="language-plaintext highlighter-rouge">A 쓰레드</code> 에서는 변수 <code class="language-plaintext highlighter-rouge">a</code>를, <code class="language-plaintext highlighter-rouge">B 쓰레드</code> 에서는 변수 <code class="language-plaintext highlighter-rouge">b</code>를 접근한다고 가정했을 때 문제가 발생한다. 위에서 이야기했던, <code class="language-plaintext highlighter-rouge">DRAM</code>에 순차적으로 정의 된 <code class="language-plaintext highlighter-rouge">변수 a와 b</code>는 각기 다른 CPU 코어의 캐시 메모리에 함께 적재되는 문제가 있다. 그렇기 때문에, <code class="language-plaintext highlighter-rouge">B 쓰레드</code>에서 사용되지 않는 <code class="language-plaintext highlighter-rouge">변수 a</code>도 함께 적재 되면서 <code class="language-plaintext highlighter-rouge">A 쓰레드</code>에서 <code class="language-plaintext highlighter-rouge">변수 a</code> 값이 변경이 된다면 <code class="language-plaintext highlighter-rouge">B 쓰레드</code>의 <code class="language-plaintext highlighter-rouge">변수 a</code>의 값도 함께 맞춰줘야하므로 생기는 문제이다.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
</code></pre></div></div> <ol> <li>스마트 포인터는 성능과 거리가 멉니다. (162p)</li> </ol> <p>스마트 포인터는 안정성과 메모리를 반드시 <code class="language-plaintext highlighter-rouge">Alloc</code>과 <code class="language-plaintext highlighter-rouge">dealloc</code> 하기 위해서 내부적으로 얼마나 변수에 대해서 참조하고 있는지 (참조 카운팅, use_count) 계산하고 있다. 하지만, C++ 표준 라이브러리는 안정성을 위해서, 특히 멀티 쓰레드 환경에서도 동작을 보장하기 위해서 참조 카운팅 변수를 <code class="language-plaintext highlighter-rouge">atomic(원자성)</code>으로 지정되어져 있다. 따라서, 스마트 포인터를 이용하여 데이터를 주고 받거나, 생성자, 파괴자가 잦은 호출이 발생이 되는 경우에는 생성자와 파괴자 호출 비용과 추가적으로 <code class="language-plaintext highlighter-rouge">atomic</code>한 변수로 인해 성능 지연이 발생하게 된다.</p> <ol> <li>비 캡처 람다는 일반 정적 함수에서 이름이 없는 것과 같다. (위치 까먹었습니다..)</li> </ol> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">auto</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span> <span class="n">cap_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// lambda</span>
<span class="n">data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

<span class="c1">// correctly work!</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
<span class="n">data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

<span class="c1">// Error! because of captured [data]</span>
<span class="n">cap_data</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span> 
</code></pre></div></div> <p>일반 함수는 코드의 길이가 짧다면 인라인화 되거나, 추가적인 최적화를 수행이 될 가능성이 있다. 그렇기 때문에, 비 캡처 람다 함수는 이상하게도 일반 정적 함수로 치환이 될 수 있고, 이를 통해 인라인화 될 가능성이 존재한다. 그렇다면 호출 스택 지점이나, Program Count의 주소, 함수의 코드 플로우가 변경이 되지 않으므로 성능 이점을 얻을 수 있다. 그렇기 떄문에 약간 신기하지만 비 캡처 람다 함수가 일반 함수와 동일하는 점이 신기하였다.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Winograd-Algorithm/">위노그라드 알고리즘 정리</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/ssh-vpn-forward/">외부에서 내부망으로 접근하기 위한 3가지의 방법론</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/GIST-Developer/">GIST Developers' Night 2024에 연사로 참가하고 나서</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/jvm-book-readed/">JVM 밑바닥까지 파헤치기 책을 읽고</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/reading-High-Performance-Cpp/">고성능을 위한 언어 C++ 책을 읽고나서</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 JooHyoung Cha. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>