<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Kubernetes에 NFS로 데이터 공유 시스템 구성 | JooHyoung Cha </title> <meta name="author" content="JooHyoung Cha"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://blog.udon.party/blog/2021/k8s-nfs/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">JooHyoung</span> Cha </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Kubernetes에 NFS로 데이터 공유 시스템 구성</h1> <p class="post-meta"> Created in December 17, 2021 by piorosen </p> <p class="post-tags"> <a href="/blog/2021"> <i class="fa-solid fa-calendar fa-sm"></i> 2021 </a>   ·   <a href="/blog/tag/k8s"> <i class="fa-solid fa-hashtag fa-sm"></i> k8s</a>   <a href="/blog/tag/nfs"> <i class="fa-solid fa-hashtag fa-sm"></i> nfs</a>   <a href="/blog/tag/ingress"> <i class="fa-solid fa-hashtag fa-sm"></i> ingress</a>   <a href="/blog/tag/service"> <i class="fa-solid fa-hashtag fa-sm"></i> service</a>   <a href="/blog/tag/pod"> <i class="fa-solid fa-hashtag fa-sm"></i> pod</a>   <a href="/blog/tag/nodeport"> <i class="fa-solid fa-hashtag fa-sm"></i> nodeport</a>   ·   <a href="/blog/category/blogging"> <i class="fa-solid fa-tag fa-sm"></i> Blogging</a>   <a href="/blog/category/cloud"> <i class="fa-solid fa-tag fa-sm"></i> Cloud</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="개요">개요</h1> <p>동아리방 서버에 OpenStack과 같은 가상머신이 아닌, 소프트웨어 단위, 즉 컨테이너 단위로 시스템을 구성하고자 한다. Kubernetes는 컨테이너 오케스트레이터 이기도 하며, 여러대의 컴퓨터를 이용하여 무 중단 시스템을 구축을 하며, 여러개의 컨테이너를 동시에 돌리기 때문에 하나의 저장공간에서 개별적으로 돌리는것에는 많은 어려움이 있다. 그래서 k8s에서 여러개의 컴퓨터에 동시에 컨테이너를 돌리기 위해서는 하나의 공유 저장 공간이 필요했다. 그래서 NFS를 이용하여 하나의 공유 시스템을 구축하고, 해당 컴퓨터에 시스템을 구축하는 방법을 설명 하고자 한다.</p> <h1 id="synology-csi-를-선택하지-않은-이유">Synology-CSI 를 선택하지 않은 이유</h1> <p>Synology를 이용해서 k8s에 공유 시스템을 구축하고자 한다면 가장 먼저 나오는 자료는</p> <ol> <li>https://github.com/jparklab/synology-csi</li> <li>https://github.com/SynologyOpenSource/synology-csi</li> </ol> <p>총 2가지의 자료가 나온다. 2번째의 자료는 시놀로지에서 직접 만든 자료이긴 하지만, 자료가 유지 보수가 정상적으로 안하고 있는것 같다. 최신버전이 1.19 로 구현이 되어 있다 보니, 현재 서버 컴퓨터에 설치 된 1.23 버전과 호환에 문제가 있는것인지 정상적으로 동작하고 있지 않다. 그래서 직접 StorageClass 또는 PV, PVC를 직접 구성 해야 했다.</p> <h1 id="네트워크-볼륨">네트워크 볼륨</h1> <p>쿠버네티스에서 공유 데이터를 만들기 위해서 k8s에서 지원하는 볼륨을 찾아보았다. <a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes" rel="external nofollow noopener" target="_blank">지원하는 볼륨</a> 목록</p> <p>그렇지만 실제로 적용할 네트워크 볼륨은 크게 iSCSI와 NFS이다. 그 외에는 클라우드에 종속적인 볼륨이 많기 때문에 프라이빗 클라우드 성향을 가지는 개인 서버에는 실제로 적용하는것은 불가능했다.</p> <p>그래서 iSCSI와 NFS 였는데 iSCSI는 AWS의 EBS처럼 SCSI의 프로토콜을 모두 네트워크로 통신으로 주고 받는 방식인 반면 NFS는 살짝 FTP와 비슷한 방식이다. 그래서 iSCSI는 작은 파일을 빠르게 많이 읽을 때 매우 빠른 성능을 보여주는 반면, NFS는 비교적 큰 파일을 읽을 때 빠른 성능을 보여준다.</p> <p>하지만 실제 개발 할 때는 소스코드 파일 자체의 용량이 작으므로 iSCSI를 적용했을 때 더 좋은 퍼포먼스나, 성능을 발휘 하겠지만 iSCSI의 가장 큰 단점은 iSCSI는 1:1 연결만 지원한다는 것이다. 즉 1개의 Pod은 1개의 iSCSI 서버가 필요하다는 의미이다.</p> <p>그리고 iSCSI의 가장 큰 단점이 하나 더 있었다.</p> <blockquote> <p>iSCSI는 1:1 마운트만을 제공한다는 점, 그리고 노드 Fail 시 다른 노드로의 Migration이 발생하지 않는다는 단점을 가진다. <a href="https://m.blog.naver.com/alice_k106/221348788068" rel="external nofollow noopener" target="_blank">출처</a></p> </blockquote> <p>그래서 NFS를 이용하여 구축하기로 하였다.</p> <h1 id="시스템-내부-구성">시스템 내부 구성</h1> <p>시스템 내부 구성은 1개의 스토리지 서버와 3개의 컴퓨터로 구성을 하였다. 스토리지 서버는 Synology의 DS218+ 를 선택하게 되었고, 컴퓨터의 경우는 가상 머신이 아닌 물리적인 컴퓨터 3대로 하게 되었다.</p> <p>1개의 외부망에 L2 스위치 허브를 연결하여 각각의 컴퓨터에 고정아이피를 할당 하였다. 하지만 NFS나 iSCSI의 경우에는 오직 내부망을 통하여 통신 하고 있을 때 가능했다. 그래서 모든 컴퓨터에 외부망과 내부망을 따로 연결 한 뒤, 라우팅 테이블을 수정하여 외부와 통신을 할 때는 외부망과 192.168.0.0/24 로 통신이 진행이 될 때 내부망으로 통신하도록 라우팅 설정 하였다.</p> <p>내부망의 정의는 L3에 있는 NAT 프로토콜을 통하여 통신이 이뤄지고 있는지로 정의가 된다.</p> <p><img src="/assets/img/post/2021-12-19-ifconfig.png" alt="이미지"></p> <p>eth0과 eth1에서 내부망과 외부망이 분리가 된다.</p> <p>이로 써 NFS 시스템을 통해 내부망 끼리 스토리지를 공유 하며, 외부와의 접속이 이뤄질 때 외부망으로 통신을 하도록 하였다.</p> <h1 id="시스템-구축-명령어">시스템 구축 명령어</h1> <p>PV와 PVC를 구축 할 때 StorageClass가 아닌 임의적으로 PV, PVC를 만들어서 직접 마운트 시켜보는 쪽으로 하였다.</p> <p>우선 PV는 아래와 같이 구성을 하였다.</p> <p>NFS의 서버는 192.168.0.40 으로 하였으며, Path는 NFS 서버에서 마운트를 할 폴더를 하였다. 그리고, accessModes는 여러 Pod이 동시에 읽고, 쓰기 작업이 일어날 수 있으므로, 여러개의 Pod이 처리할 수 있도록 하였다.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pv</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
  <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Recycle</span>
  <span class="na">mountOptions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">hard</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteMany</span>
  <span class="na">nfs</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">192.168.0.40</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/volume1/kubernetes/test2</span>
</code></pre></div></div> <p>PVC는 PV와 맞춰야 하므로 용량은 20GB로 잡았다.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteMany</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
</code></pre></div></div> <p>그리고 테스트를 하기 위한 Pod과 매번 재생성이 일어나는지 테스트를 하기 위해서 Deployment와 Pod, 그리고 외부 접속을 하기 위해서 Service를 작성 하였다.</p> <p>Deployment는 replicas를 통해 여러개의 pod이 균일하게 생성이 되도록 만들어 주는 기능이며, Pod은 Docker로 표현하자면 하나의 Docker-Compose와 같은 컨테이너 이다. Service는 NodePort를 사용하였는데 NodePort는 외부망에서 k8s로 접근을 할 때 사용되는 서비스 이다.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-deployment</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span> 
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pvs</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">pvc</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http-server"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/usr/share/nginx/html"</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">pvs</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30007</span>
</code></pre></div></div> <p><img src="/assets/img/post/2021-12-19-deployment.png" alt="이미지"></p> <p>위의 이미지 처럼 총 모두 5개의 Pod이 모두 정상적으로 동작하는것을 확인이 가능하다.</p> <p><img src="/assets/img/post/2021-12-19-test.png" alt="이미지"></p> <p>이 처럼 매번 서버에 접근이 이뤄질 때 마다 발생하는 pod이 다름에도 불구하고 정상적으로 동작하는것을 볼 수 있다.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Winograd-Algorithm/">위노그라드 알고리즘 정리</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/ssh-vpn-forward/">외부에서 내부망으로 접근하기 위한 3가지의 방법론</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/GIST-Developer/">GIST Developers' Night 2024에 연사로 참가하고 나서</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/jvm-book-readed/">JVM 밑바닥까지 파헤치기 책을 읽고</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/reading-High-Performance-Cpp/">고성능을 위한 언어 C++ 책을 읽고나서</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 JooHyoung Cha. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>