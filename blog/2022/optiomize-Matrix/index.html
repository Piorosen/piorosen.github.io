<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Intel SIMD를 통한 고속 행렬 연산(기초) | JooHyoung Cha </title> <meta name="author" content="JooHyoung Cha"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://blog.udon.party/blog/2022/optiomize-Matrix/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">JooHyoung</span> Cha </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Intel SIMD를 통한 고속 행렬 연산(기초)</h1> <p class="post-meta"> Created in October 04, 2022 by piorosen </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/simd"> <i class="fa-solid fa-hashtag fa-sm"></i> SIMD</a>   <a href="/blog/tag/intel"> <i class="fa-solid fa-hashtag fa-sm"></i> Intel</a>   <a href="/blog/tag/sse"> <i class="fa-solid fa-hashtag fa-sm"></i> SSE</a>   <a href="/blog/tag/naive"> <i class="fa-solid fa-hashtag fa-sm"></i> naive</a>   ·   <a href="/blog/category/blogging"> <i class="fa-solid fa-tag fa-sm"></i> Blogging</a>   <a href="/blog/category/develop"> <i class="fa-solid fa-tag fa-sm"></i> Develop</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="개요">개요</h1> <p>Single Instruction Multiple Data(SIMD) 기술은 1회 연산에 여러개의 데이터를 병렬적으로 처리하는 기술이다. 관련된 자료는 찾아보면 엄청 많이 있으므로 생략을 한다. 간단하게 설명을 하자면 CPU의 클럭은 보통 Dynamic Voltage Frequency Scaling(DVFS)나, 내부적인 Time Slice(Task) 스케줄링 기법이 없다면 보통은 고정적이다. 즉, 반복문을 수천 수만번 반복을 한다면 특별한 사유(백그라운드 프로그램 및 L1, L2 캐시, 주 메모리의 쓰로틀링)가 없다면 Performance Monitor Unit(PMU)에서 성능 측정한다면 거의 오차가 없다. 또는 없어야 한다. 그런 제한적인 성능에서 더 많은 연산을 수행하기 위해 SIMD를 통하여 1회 연산에서 병렬처리를 할 수 있다.</p> <h1 id="기존-행렬-연산">기존 행렬 연산</h1> <p>기존 행렬의 곱셈은 MxN * NxK = MxK 의 값을 구하는 구조이다. 그렇기 때문에 3중 반복문을 통하여 MxK 와 N번 반복을 한다면 모든 연산을 수행 할 수 있다. 그래서 아래의 코드 처럼 3중 반복문과 곱셈과 덧셈을 통해 구현 할 수 있다. 512x512 * 512x512 행렬의 연산을 수행하면 약 1초 이상의 시간이 소요가 된다.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_DIM</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DIM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_DIM</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_DIM</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">MAX_DIM</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">MAX_DIM</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">MAX_DIM</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h1 id="streaming-simd-extensions를-통한-최적화">Streaming SIMD Extensions를 통한 최적화</h1> <p>하지만 SIMD의 구현체 중 하나인 SSE를 활용 한다면 1 클럭에 여러번 연산을 수행할 수 있다. 현재 사용한 SSE는 128비트를 한번에 연산하는 기능이며, 16비트 Short를 곱, 덧셈 하므로, 1 클럭에 8개의 데이터를 병렬 처리 한다. 이로써, 기존 성능에 비해 8배 더 빠른 결과를 낼 수 있다.</p> <blockquote> <p>문서: https://stackoverflow.com/questions/40313434/sse-matrix-matrix-multiplication</p> </blockquote> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// this is significantly better but doesn't do any cache-blocking</span>
<span class="kt">void</span> <span class="nf">matmulSSE</span><span class="p">(</span><span class="kt">short</span><span class="o">*</span> <span class="n">mat1</span><span class="p">,</span> <span class="kt">short</span><span class="o">*</span> <span class="n">mat2</span><span class="p">,</span> <span class="kt">short</span><span class="o">*</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DIM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_DIM</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// vectorize over this loop</span>
            <span class="n">__m128i</span> <span class="n">vR</span> <span class="o">=</span> <span class="n">_mm_setzero_si128</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_DIM</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// not this loop</span>
                <span class="n">__m128i</span> <span class="n">vA</span> <span class="o">=</span> <span class="n">_mm_set1_epi16</span><span class="p">(</span><span class="n">mat1</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">MAX_DIM</span> <span class="o">+</span> <span class="n">k</span><span class="p">]);</span>  <span class="c1">// load+broadcast is much cheaper than MOVD + 3 inserts (or especially 4x insert, which your new code is doing)</span>
                <span class="n">__m128i</span> <span class="n">vB</span> <span class="o">=</span> <span class="n">_mm_loadu_si128</span><span class="p">((</span><span class="n">__m128i</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mat2</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">MAX_DIM</span> <span class="o">+</span> <span class="n">j</span><span class="p">]);</span>  <span class="c1">// mat2[k][j+0..3]</span>
                <span class="n">vR</span> <span class="o">=</span> <span class="n">_mm_add_epi16</span><span class="p">(</span><span class="n">vR</span><span class="p">,</span> <span class="n">_mm_mullo_epi16</span><span class="p">(</span><span class="n">vA</span><span class="p">,</span> <span class="n">vB</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="n">_mm_storeu_si128</span><span class="p">((</span><span class="n">__m128i</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">MAX_DIM</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">vR</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h1 id="결과">결과</h1> <p>SIMD가 아닌, Naive한 구현체로는 성능이 약 2.5초가 걸리지만, SSE로 구현한 예제는 2배 빠른 1.2초의 시간이 걸리면서 약 2배의 시간이 단축 되었다. 그리고 FastIO를 통하여 0.7초 까지 단축 할 수 있었다.</p> <p><img src="/assets/img/post/2022-10-05-result.png" alt="결과 이미지 성능비교"></p> <h1 id="결론-글-쓰기가-매우-귀찮다">결론 글 쓰기가 매우 귀찮다…</h1> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Winograd-Algorithm/">위노그라드 알고리즘 정리</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/ssh-vpn-forward/">외부에서 내부망으로 접근하기 위한 3가지의 방법론</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/GIST-Developer/">GIST Developers' Night 2024에 연사로 참가하고 나서</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 JooHyoung Cha. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>